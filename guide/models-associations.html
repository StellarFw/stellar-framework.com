
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Associations - Stellar</title>
    <meta charset="utf-8">
    <meta name="description" content="Stellar is an action based web framework for creating Web APIs easily!">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Associations - Stellar">
    <meta property="og:description" content="Stellar is an action based web framework for creating Web APIs easily!">
    <meta property="og:image" content="https://stellar-framework.com/images/logo.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Associations - Stellar">
    <meta name="twitter:description" content="Stellar is an action based web framework for creating Web APIs easily!">
    <meta name="twitter:image" content="https://stellar-framework.com/images/logo.png">

    <link rel="icon" href="/images/logo.png" type="image/x-icon">

    <!-- color to use by the browsers -->
    <meta name="theme-color" content="#98588C">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Dosis:500' rel='stylesheet' type='text/css'>

    <!-- main page styles -->
    <link rel="stylesheet" href="/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts -->
    <script>window.PAGE_TYPE = 'guide'</script>
  </head>
  <body class="docs">    <div id="mobile-bar" >
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>

    <div id="header">
    <a id="logo" href="/">
        <img src="/images/logo.png">
        <span>Stellar</span>
    </a>
    <ul id="nav">
        <li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input">
  </form>
</li>
<li><a href="/guide/" class="nav-link current">Guide</a></li>
<li class="nav-dropdown-container">
  <a class="nav-link">Community</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="https://github.com/stellarFw/stellar" class="nav-link" target="_blank">GitHub</a></li>
    <li><a href="https://gitter.im/StellarFw/StellarFw" class="nav-link" target="_blank">Chat</a></li>
    <li><a href="https://twitter.com/gil0mendes" class="nav-link" target="_blank">Twitter</a></li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">Ecosystem</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="https://github.com/StellarFw/Identify" class="nav-link" target="_blank">Identify</a></li>
  </ul>
</li>


    </ul>
</div>

    
      <div id="main" class="fix-sidebar">
        
          
  <div class="sidebar">
  <ul class="main-menu">
    <li>
  <form id="search-form">
    <input type="text" id="search-query-sidebar" class="search-query st-default-search-input">
  </form>
</li>
<li><a href="/guide/" class="nav-link current">Guide</a></li>
<li class="nav-dropdown-container">
  <a class="nav-link">Community</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="https://github.com/stellarFw/stellar" class="nav-link" target="_blank">GitHub</a></li>
    <li><a href="https://gitter.im/StellarFw/StellarFw" class="nav-link" target="_blank">Chat</a></li>
    <li><a href="https://twitter.com/gil0mendes" class="nav-link" target="_blank">Twitter</a></li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">Ecosystem</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="https://github.com/StellarFw/Identify" class="nav-link" target="_blank">Identify</a></li>
  </ul>
</li>


  </ul>
  <div class="list">
    <div class="main-sponsor"></div>
    <a class="become-backer" href="/support-stellar">
      Become a Backer
    </a>

    <ul class="menu-root">
      
        
        
          
        

        <li>
          <a href="/guide/index.html" class="sidebar-link">Overview</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/installation.html" class="sidebar-link">Installation</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/actions.html" class="sidebar-link">Actions</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/tasks.html" class="sidebar-link">Tasks</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/middleware.html" class="sidebar-link">Middleware</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/satellites.html" class="sidebar-link">Satellites</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/cluster.html" class="sidebar-link">Cluster</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/cache.html" class="sidebar-link">Cache</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/chat.html" class="sidebar-link">Chat</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/development_mode.html" class="sidebar-link">Development Mode</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/file_system.html" class="sidebar-link">File System</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/events.html" class="sidebar-link">Events</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/websocket.html" class="sidebar-link">WebSocket</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/tcp.html" class="sidebar-link">TCP</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/http.html" class="sidebar-link">HTTP</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/security.html" class="sidebar-link">Security</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/validation.html" class="sidebar-link">Validation</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/logging.html" class="sidebar-link">Logging</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/commands.html" class="sidebar-link">Commands</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/testing.html" class="sidebar-link">Testing</a>
        </li>
      
        
        
          
            <li><h3>Models</h3></li>
          
        

        <li>
          <a href="/guide/models.html" class="sidebar-link">Introduction</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/models-data_types.html" class="sidebar-link">Data Types and Attributes</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/models-validations.html" class="sidebar-link">Validations</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/models-instance.html" class="sidebar-link">Instance and Class Methods</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/models-associations.html" class="sidebar-link current">Associations</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/models-configurations.html" class="sidebar-link">Model Configuration</a>
        </li>
      
        
        
          
        

        <li>
          <a href="/guide/models-queries.html" class="sidebar-link">Queries</a>
        </li>
      
    </ul>
  </div>
</div>



<div class="content guide with-sidebar models-associations-guide">
  
    <h1>Associations</h1>
  

  <p>With our ORM you can associate models with other models across all datastores. This means that your users can live in PostgreSQL and their photos can live in MongoDB and you can interact with the data as if they lived together on the same database. You can also have associations that live on separate connections or in different databases within the same adapter.</p>
<p>The following guides will walk you through the various ways that your data can be associated and how to setup and query associated data.</p>
<ul>
<li><a href="#one-to-one">One-to-one</a></li>
<li><a href="#one-to-many">One-to-many</a></li>
<li><a href="#many-to-many">Many-to-many</a></li>
<li><a href="#dominance">Dominance</a></li>
</ul>
<p><div id="one-to-one"></div></p>
<h2 id="One-to-One-Associations"><a href="#One-to-One-Associations" class="headerlink" title="One-to-One Associations"></a>One-to-One Associations</h2><p>A one-to-one association states that a model may only be associated with one other model. In order for the model to know which other model it is associated with a foreign key must be included in the record.</p>
<p>The ORM uses the concept of a <code>model</code> attribute to indicate that a record should store a reference to another model. Whenever this attribute is found a <code>foreignKey</code> will be built up in the underlying schema to handle the association.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// user.js - A user may only have a single pet</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">firstName</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">lastName</span>: <span class="string">'string'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add a reference to Pet</span></div><div class="line">    pet: &#123;</div><div class="line">      <span class="attr">model</span>: <span class="string">'pet'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// pet.js - A Pet may have multiple users</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">breed</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">name</span>: <span class="string">'string'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In the above example we are associating a <code>Pet</code> with a <code>User</code>. The <code>User</code> may only have one <code>Pet</code> in this case but a <code>Pet</code> is not limited to a single <code>User</code>. Because we have only formed an association on one of the models, a <code>Pet</code> has no restrictions on the number of <code>User</code> models it can belong to. We can change this and associate the <code>Pet</code> with exactly one <code>User</code> and the <code>User</code> with exactly one <code>Pet</code>.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// user.js - A user may only have a single pet</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">firstName</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">lastName</span>: <span class="string">'string'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add a reference to Pet</span></div><div class="line">    pet: &#123;</div><div class="line">      <span class="attr">model</span>: <span class="string">'pet'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// pet.js</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">breed</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">name</span>: <span class="string">'string'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add a reference to User</span></div><div class="line">    user: &#123;</div><div class="line">      <span class="attr">model</span>: <span class="string">'user'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now that both models know about each other you can query the association from both sides. To add an association to a model when creating a record you can use the named attribute you set in the model definition.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">Pet.create(&#123;</div><div class="line">  <span class="attr">breed</span>: <span class="string">'labrador'</span>,</div><div class="line">  <span class="attr">type</span>: <span class="string">'dog'</span>,</div><div class="line">  <span class="attr">name</span>: <span class="string">'fido'</span>,</div><div class="line"></div><div class="line">  <span class="comment">// Set the User's Primary Key to associate the Pet with the User.</span></div><div class="line">  user: <span class="number">123</span></div><div class="line">&#125;)</div><div class="line">.exec(<span class="function">(<span class="params">err, pet</span>) =&gt;</span> &#123; &#125;)</div></pre></td></tr></table></figure>
<p>This will create a new <code>Pet</code> record with the <code>User</code> foreignKey set. It will allow you to query a <code>Pet</code> and retrieve their owners, but the <code>User</code> side of the association doesn’t know about the <code>Pet</code>. To ensure you can query both ways the <code>User</code> record will need to be updated with the new <code>Pet</code> record. You can do this in many ways but a simple nested example may look like this:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">Pet.create(&#123;</div><div class="line">  <span class="attr">breed</span>: <span class="string">'labrador'</span>,</div><div class="line">  <span class="attr">type</span>: <span class="string">'dog'</span>,</div><div class="line">  <span class="attr">name</span>: <span class="string">'fido'</span>,</div><div class="line"></div><div class="line">  <span class="comment">// Set the User's Primary Key to associate the Pet with the User.</span></div><div class="line">  user: <span class="number">123</span></div><div class="line">&#125;)</div><div class="line">.exec(<span class="function">(<span class="params">err, pet</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">if</span> (err) <span class="comment">// Handle Error</span></div><div class="line"></div><div class="line">  User.update(<span class="number">123</span>, &#123; <span class="attr">pet</span>: pet.id &#125;).exec(<span class="function">(<span class="params">err, user</span>) =&gt;</span> &#123; &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Now that the associations are created you can query the records and include the associated data. To do this the <code>populate</code> option is used. This will add a key to each model returned that contains an object with the corresponding record. Because we set the association on both sides above you could use <code>populate</code> on either side.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">Pet.find()</div><div class="line">.populate(<span class="string">'user'</span>)</div><div class="line">.exec(<span class="function">(<span class="params">err, pets</span>) =&gt;</span> &#123;</div><div class="line"></div><div class="line">  <span class="comment">// The pets object would look something like the following</span></div><div class="line">  <span class="comment">// [&#123;</span></div><div class="line">  <span class="comment">//   id: 1,</span></div><div class="line">  <span class="comment">//   breed: 'labrador',</span></div><div class="line">  <span class="comment">//   type: 'dog',</span></div><div class="line">  <span class="comment">//   name: 'fido',</span></div><div class="line">  <span class="comment">//   user: &#123;</span></div><div class="line">  <span class="comment">//     id: 123,</span></div><div class="line">  <span class="comment">//     firstName: 'Foo',</span></div><div class="line">  <span class="comment">//     lastName: 'Bar',</span></div><div class="line">  <span class="comment">//     pet: 1</span></div><div class="line">  <span class="comment">//   &#125;</span></div><div class="line">  <span class="comment">// &#125;]</span></div><div class="line"></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="One-to-One-with-Existing-Tables"><a href="#One-to-One-with-Existing-Tables" class="headerlink" title="One-to-One with Existing Tables"></a>One-to-One with Existing Tables</h3><p>These one-to-one relationships will also work if you’re using a legacy database. You’ll have to specify a <code>tableName</code> attribute, along with appropriate <code>columnName</code>s for each field attribute.</p>
<p>In this example, PetBiz prefixes all of their tables and fields with <code>pb_</code>. So the Pet model becomes:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">tableName</span>: <span class="string">'pb_pets'</span></div><div class="line"></div><div class="line">  attributes: &#123;</div><div class="line">    <span class="attr">id</span>: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'integer'</span>,</div><div class="line">      <span class="attr">primaryKey</span>: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">breed</span>: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">columnName</span>: <span class="string">'pb_pet_breed'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">animal</span>: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">columnName</span>: <span class="string">'pb_pet_species'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">name</span>: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">columnName</span>: <span class="string">'pb_pet_name'</span></div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// And here we make the association:</span></div><div class="line">    owner: &#123;</div><div class="line">      <span class="attr">model</span>: <span class="string">'user'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Meanwhile, the <code>User</code> would look something like this:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">tableName</span>: <span class="string">'pb_user'</span></div><div class="line"></div><div class="line">  attributes: &#123;</div><div class="line">    <span class="attr">id</span>: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'integer'</span>,</div><div class="line">      <span class="attr">primaryKey</span>: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">firstName</span>: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">columnName</span>: <span class="string">'pb_owner_first'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">lastName</span>: &#123;</div><div class="line">      <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">      <span class="attr">columnName</span>: <span class="string">'pb_owner_last'</span></div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// Add a reference to Pet</span></div><div class="line">    pet: &#123;</div><div class="line">      <span class="attr">model</span>: <span class="string">'pet'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>With just these minor changes to the model, the queries described earlier should work the same.</p>
<p><div id="one-to-many"></div></p>
<h2 id="One-to-Many-Associations"><a href="#One-to-Many-Associations" class="headerlink" title="One-to-Many Associations"></a>One-to-Many Associations</h2><p>A one-to-many association states that a model can be associated with many other models. To build this association a virtual attribute is added to a model using the <code>collection</code> property. In a one-to-many association one side must have a <code>collection</code> attribute and the other side must contain a <code>model</code> attribute. This allows the many side to know which records it needs to get when a <code>populate</code> is used.</p>
<p>Because you may want a model to have multiple one-to-many associations on another model, a <code>via</code> key is needed on the <code>collection</code> attribute. This states which <code>model</code> attribute on the one side of the association is used to populate the records.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// user.js - A user may have many pets</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">firstName</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">lastName</span>: <span class="string">'string'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add a reference to Pets</span></div><div class="line">    pets: &#123;</div><div class="line">      <span class="attr">collection</span>: <span class="string">'pet'</span>,</div><div class="line">      <span class="attr">via</span>: <span class="string">'owner'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// pet.js - A pet may only belong to a single user</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">breed</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">name</span>: <span class="string">'string'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add a reference to User</span></div><div class="line">    owner: &#123;</div><div class="line">      <span class="attr">model</span>: <span class="string">'user'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now that the pets and users know about each other, they can be associated. To do this we can create or update a pet with the user’s primary key for the <code>owner</code> value.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">Pet.create(&#123;</div><div class="line">  <span class="attr">breed</span>: <span class="string">'labrador'</span>,</div><div class="line">  <span class="attr">type</span>: <span class="string">'dog'</span>,</div><div class="line">  <span class="attr">name</span>: <span class="string">'fido'</span>,</div><div class="line"></div><div class="line">  <span class="comment">// Set the User's Primary Key to associate the Pet with the User.</span></div><div class="line">  owner: <span class="number">123</span></div><div class="line">&#125;)</div><div class="line">.exec(<span class="function">(<span class="params">err, pet</span>) =&gt;</span> &#123; &#125;)</div></pre></td></tr></table></figure>
<p>Now that the <code>Pet</code> is associated with the <code>User</code>, all the pets belonging to a specific user can be populated by using the <code>populate</code> method.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">User.find()</div><div class="line">.populate(<span class="string">'pets'</span>)</div><div class="line">.then(<span class="function"><span class="params">users</span> =&gt;</span> &#123;</div><div class="line">  <span class="comment">// The users object would look something like the following</span></div><div class="line">  <span class="comment">// [&#123;</span></div><div class="line">  <span class="comment">//   id: 123,</span></div><div class="line">  <span class="comment">//   firstName: 'Foo',</span></div><div class="line">  <span class="comment">//   lastName: 'Bar',</span></div><div class="line">  <span class="comment">//   pets: [&#123;</span></div><div class="line">  <span class="comment">//     id: 1,</span></div><div class="line">  <span class="comment">//     breed: 'labrador',</span></div><div class="line">  <span class="comment">//     type: 'dog',</span></div><div class="line">  <span class="comment">//     name: 'fido',</span></div><div class="line">  <span class="comment">//     owner: 123</span></div><div class="line">  <span class="comment">//   &#125;]</span></div><div class="line">  <span class="comment">// &#125;]</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><div id="many-to-many"></div></p>
<h2 id="Many-to-Many-Associations"><a href="#Many-to-Many-Associations" class="headerlink" title="Many-to-Many Associations"></a>Many-to-Many Associations</h2><p>A many-to-many association states that a model can be associated with many other models and vice-versa. Because both models can have many related models a new join table will need to be created to keep track of these relations.</p>
<p>The ORM will look at your models and if it finds that two models both have collection attributes that point to each other, it will automatically build up a join table for you.</p>
<p>Because you may want a model to have multiple many-to-many associations on another model a <code>via</code> key is needed on the <code>collection</code> attribute. This states which <code>model</code> attribute on the one side of the association is used to populate the records.</p>
<p>You will also need to add a <code>dominant</code> property on one side of the association. This allows the ORM to know which side it can write the join table to in the case of different connections.</p>
<p>Using the <code>User</code> and <code>Pet</code> example, let’s look at how to build a schema where a <code>User</code> may have many <code>Pet</code> records and a <code>Pet</code> may have multiple owners.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// user.js - A user may have many pets</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">firstName</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">lastName</span>: <span class="string">'string'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add a reference to Pet</span></div><div class="line">    pets: &#123;</div><div class="line">      <span class="attr">collection</span>: <span class="string">'pet'</span>,</div><div class="line">      <span class="attr">via</span>: <span class="string">'owners'</span>,</div><div class="line">      <span class="attr">dominant</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// A pet may have many owners</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">breed</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">type</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">name</span>: <span class="string">'string'</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Add a reference to User</span></div><div class="line">    owners: &#123;</div><div class="line">      <span class="attr">collection</span>: <span class="string">'user'</span>,</div><div class="line">      <span class="attr">via</span>: <span class="string">'pets'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now that the <code>User</code> and <code>Pet</code> models have been created and the join table has been setup automatically, we can start associating records and querying the join table. To do this, let’s add a <code>User</code> and <code>Pet</code> and then associate them together.</p>
<p>There are two ways of creating associations when a many-to-many association is used. You can associate two existing records together or you can associate a new record to the existing record. To show how this is done we will introduce the special methods attached to a <code>collection</code> attribute: <code>add</code> and <code>remove</code>.</p>
<p>Both these methods are sync methods that will queue up a set of operations to be run when an instance is saved. If a primary key is used for the value on an <code>add</code>, a new record in the join table will be created linking the current model to the record specified in the primary key. However if an object is used as the value in an <code>add</code>, a new model will be created and then the primary key of that model will be used in the new join table record. You can also use an array of previous values.</p>
<h3 id="When-Both-Records-Exist"><a href="#When-Both-Records-Exist" class="headerlink" title="When Both Records Exist"></a>When Both Records Exist</h3><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Given a User with ID 2 and a Pet with ID 20</span></div><div class="line"></div><div class="line">User.findOne(<span class="number">2</span>).then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</div><div class="line">  <span class="comment">// Queue up a record to be inserted into the join table</span></div><div class="line">  user.pets.add(<span class="number">20</span>)</div><div class="line"></div><div class="line">  <span class="comment">// Save the user, creating the new associations in the join table</span></div><div class="line">  user.save(<span class="function"><span class="params">err</span> =&gt;</span> &#123; &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="With-A-New-Record"><a href="#With-A-New-Record" class="headerlink" title="With A New Record"></a>With A New Record</h3><figure class="highlight js"><table><tr><td class="code"><pre><div class="line">User.findOne(<span class="number">2</span>).then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</div><div class="line">  <span class="comment">// Queue up a new pet to be added and a record to be created in the join table</span></div><div class="line">  user.pets.add(&#123; <span class="attr">breed</span>: <span class="string">'labrador'</span>, <span class="attr">type</span>: <span class="string">'dog'</span>, <span class="attr">name</span>: <span class="string">'fido'</span> &#125;)</div><div class="line"></div><div class="line">  <span class="comment">// Save the user, creating the new pet and associations in the join table</span></div><div class="line">  user.save(<span class="function"><span class="params">err</span> =&gt;</span> &#123; &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="With-An-Array-of-New-Record"><a href="#With-An-Array-of-New-Record" class="headerlink" title="With An Array of New Record"></a>With An Array of New Record</h3><figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Given a User with ID 2 and a Pet with ID 20, 24, 31</span></div><div class="line"></div><div class="line">User.findOne(<span class="number">2</span>).then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</div><div class="line">  <span class="comment">// Queue up a record to be inserted into the join table</span></div><div class="line">  user.pets.add([ <span class="number">20</span>, <span class="number">24</span>, <span class="number">31</span> ])</div><div class="line"></div><div class="line">  <span class="comment">// Save the user, creating the new pet and associations in the join table</span></div><div class="line">  user.save(<span class="function"><span class="params">err</span> =&gt;</span> &#123; &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Removing associations is just as easy using the <code>remove</code> method. It works the same as the <code>add</code> method except it only accepts primary keys as a value. The two methods can be used together as well.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line">User.findOne(<span class="number">2</span>).then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</div><div class="line">  <span class="comment">// Queue up a new pet to be added and a record to be created in the join table</span></div><div class="line">  user.pets.add(&#123; <span class="attr">breed</span>: <span class="string">'labrador'</span>, <span class="attr">type</span>: <span class="string">'dog'</span>, <span class="attr">name</span>: <span class="string">'fido'</span> &#125;)</div><div class="line"></div><div class="line">  <span class="comment">// Queue up a join table record to remove</span></div><div class="line">  user.pets.remove(<span class="number">22</span>)</div><div class="line"></div><div class="line">  <span class="comment">// Save the user, creating the new pet and syncing the associations in the join table</span></div><div class="line">  user.save(<span class="function"><span class="params">err</span> =&gt;</span> &#123; &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><div id="dominance"></div></p>
<h2 id="Dominance"><a href="#Dominance" class="headerlink" title="Dominance"></a>Dominance</h2><p>Take a look to the following ontology:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// user.js</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">email</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">wishlist</span>: &#123;</div><div class="line">      <span class="attr">collection</span>: <span class="string">'product'</span>,</div><div class="line">      <span class="attr">via</span>: <span class="string">'wishlistedBy'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// product.js</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">connection</span>: <span class="string">'ourRedis'</span>,</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">name</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">wishlistedBy</span>: &#123;</div><div class="line">      <span class="attr">collection</span>: <span class="string">'user'</span>,</div><div class="line">      <span class="attr">via</span>: <span class="string">'wishlist'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h3><p>It’s easy to see what’s going on in this cross-adapter relationship. There’s a many-to-many ( <code>N-&gt;...</code> ) relationship between users and products.  In fact, you can imagine a few other relationships (e.g. purchases) which might exist, but since those are probably better-represented using a middleman model, I went for something simple in this example.</p>
<p>Anyways, that’s all great… but where does the relationship resource live?  “ProductUser”, if you’ll pardon the SQL-oriented nomenclature. We know it’ll end up on one side or the other, but what if we want to control which database it ends up in?</p>
<blockquote>
<p><strong>IMPORTANT NOTE</strong></p>
<p>This is only a problem because both sides of the association have a <code>via</code> modifier specified. In the absence of <code>via</code>, a collection attribute always behaves as <code>dominant: true</code>. See the FAQ below for more information.</p>
</blockquote>
<h3 id="The-Solution"><a href="#The-Solution" class="headerlink" title="The Solution"></a>The Solution</h3><p>Eventually, it may even be possible to specify a 3rd connection/adapter to use for the join table. For now, we’ll focus on choosing one side or the other.</p>
<p>We address this through the concept of “dominance.”  In any cross-adapter model relationship, one side is assumed to be dominant. It may be helpful to think about the analogy of a child with multinational parents who must choose one country or the other for her <a href="http://en.wikipedia.org/wiki/Japanese_nationality_law" target="_blank" rel="external">citizenship</a></p>
<p>Here’s the ontology again, but this time we’ll indicate the MySQL database as the “dominant”.  This means that the “ProductUser” relationship “table” will be stored as a MySQL table.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// user.js</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">connection</span>: <span class="string">'ourMySQL'</span>,</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">email</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">wishlist</span>: &#123;</div><div class="line">      <span class="attr">collection</span>: <span class="string">'product'</span>,</div><div class="line">      <span class="attr">via</span>: <span class="string">'wishlistedBy'</span>,</div><div class="line">      <span class="attr">dominant</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><div class="line"><span class="comment">// product.js</span></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">connection</span>: <span class="string">'ourRedis'</span>,</div><div class="line">  <span class="attr">attributes</span>: &#123;</div><div class="line">    <span class="attr">name</span>: <span class="string">'string'</span>,</div><div class="line">    <span class="attr">wishlistedBy</span>: &#123;</div><div class="line">      <span class="attr">collection</span>: <span class="string">'user'</span>,</div><div class="line">      <span class="attr">via</span>: <span class="string">'wishlist'</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Choosing-a-“dominant”"><a href="#Choosing-a-“dominant”" class="headerlink" title="Choosing a “dominant”"></a>Choosing a “dominant”</h3><p>Several factors may influence your decision:</p>
<ul>
<li>If one side is a SQL database, placing the relationship table on that side will allow your queries to be more efficient, since the relationship table can be joined before the other side is communicated with. This reduces the number of total queries required from 3 to 2.</li>
<li>If one connection is much faster than the other, all other things being equal, it probably makes sense to put the connection on that side.</li>
<li>If you know that it is much easier to migrate one of the connections, you may choose to set that side as <code>dominant</code>.  Similarly, regulations or compliance issues may affect your decision as well. If the relationship contains sensitive patient information (for instance, a relationship between <code>Patient</code> and <code>Medicine</code>) you want to be sure that all relevant data is saved in one particular database over the other (in this case, <code>Patient</code> is likely to be <code>dominant</code>).</li>
<li>Along the same lines, if one of your connections is read-only (perhaps <code>Medicine</code> in the previous example is connected to a read-only vendor database), you won’t be able to write to it, so you’ll want to make sure your relationship data can be persisted safely on the other side.</li>
</ul>
<h3 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h3><h4 id="What-if-one-of-the-collections-doesn’t-have-via"><a href="#What-if-one-of-the-collections-doesn’t-have-via" class="headerlink" title="What if one of the collections doesn’t have via?"></a>What if one of the collections doesn’t have <code>via</code>?</h4><p>If a <code>collection</code> association does not have a <code>via</code> property, it is automatically <code>dominant: true</code>.</p>
<h4 id="What-if-neither-collection-has-via"><a href="#What-if-neither-collection-has-via" class="headerlink" title="What if neither collection has via?"></a>What if neither collection has <code>via</code>?</h4><p>If neither <code>collection</code> association has <code>via</code>, then they are not related.  Both are <code>dominant</code>, because they are separate relationship tables!</p>
<h4 id="What-about-model-associations"><a href="#What-about-model-associations" class="headerlink" title="What about model associations?"></a>What about <code>model</code> associations?</h4><p>In all other types of associations, the <code>dominant</code> property is prohibited.  Setting one side to <code>dominant</code> is only necessary for associations between two models which have an attribute like: <code>{ via: &#39;...&#39;, collection: &#39;...&#39; }</code> on both sides.</p>
<h4 id="Can-a-model-be-dominant-for-one-attribute-and-not-another"><a href="#Can-a-model-be-dominant-for-one-attribute-and-not-another" class="headerlink" title="Can a model be dominant for one attribute and not another?"></a>Can a model be dominant for one attribute and not another?</h4><p>Keep in mind that a model is “dominant” only in the context of a particular relationship.  A model may be dominant in one or more relationships (attributes) while simultaneously NOT being dominant in other relationships (attributes).</p>
<p>e.g. if a <code>User</code> has a collection of toys called <code>favoriteToys</code> via <code>favoriteToyOf</code> on the <code>Toy</code> model, and <code>favoriteToys</code> on <code>User</code> is <code>dominant: true</code>, <code>Toy</code> can still be dominant in other ways.  So <code>Toy</code> might also be associated to <code>User</code> by way of its attribute, <code>designedBy</code>, for which it is <code>dominant: true</code>.</p>
<h4 id="Can-both-models-be-dominant"><a href="#Can-both-models-be-dominant" class="headerlink" title="Can both models be dominant?"></a>Can both models be dominant?</h4><p>No. If both models in a cross-adapter/cross-connection, many-to-many association set <code>dominant: true</code>, an error is thrown before lift.</p>
<h4 id="Can-neither-model-be-dominant"><a href="#Can-neither-model-be-dominant" class="headerlink" title="Can neither model be dominant?"></a>Can neither model be dominant?</h4><p>Sort of… If neither model in a cross-adapter/cross-connection, many-to-many association sets <code>dominant: true</code>, a warning is displayed before lift, and a guess will be made automatically based on the characteristics of the relationship.  For now, that just means an arbitrary decision based on alphabetical order :)</p>
<h4 id="What-about-non-cross-adapter-associations"><a href="#What-about-non-cross-adapter-associations" class="headerlink" title="What about non-cross-adapter associations?"></a>What about non-cross-adapter associations?</h4><p>The <code>dominant</code> property is silently ignored in non-cross-adapter/cross-connection associations.  We’re assuming you might be planning on breaking up the schema across multiple connections eventually, and there’s no reason to prevent you from being proactive.  Plus, this reserves additional future utility for the “dominant” option down the road.</p>


  
      <div class="guide-links">
        
          <span>← <a href="/guide/models-instance.html">Instance and Class Methods</a></span>
        
          <span>← <a href="/guide/models-validations.html">Validations</a></span>
        
        
      </div>
    

    <div class="footer">
      Caught a mistake or want to contribute to documentation?
      <a href="https://github.com/StellarFw/stellar-framework.com/tree/master/src/guide/models-associations.md" target="_blank">
        Edit this page on Github!
      </a>
    </div>
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- search -->
    <link href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/search.css">
    <script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js" type="text/javascript"></script>

    <!-- main custom script for sidebar and other cool things -->
    <script src="/js/common.js"></script>

    <!-- ga -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-77611901-1', 'stellar-framework.com');
      ga('send', 'pageview');
    </script>

    <!-- fastclick  -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        FastClick.attach(document.body)
      }, false)
    </script>
  </body>
</html>
