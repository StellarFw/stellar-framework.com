
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Tasks - Stellar</title>
    <meta charset="utf-8">
    <meta name="description" content="Stellar is an action based web framework for creating Web APIs easily!">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Tasks - Stellar">
    <meta property="og:description" content="Stellar is an action based web framework for creating Web APIs easily!">
    <meta property="og:image" content="https://stellar-framework.com/images/logo.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Tasks - Stellar">
    <meta name="twitter:description" content="Stellar is an action based web framework for creating Web APIs easily!">
    <meta name="twitter:image" content="https://stellar-framework.com/images/logo.png">

    <link rel="icon" href="/images/logo.png" type="image/x-icon">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Dosis:500' rel='stylesheet' type='text/css'>

    <!-- main page styles -->
    <link rel="stylesheet" href="/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts -->
    <script>window.PAGE_TYPE = 'guide'</script>
  </head>
  <body class="docs">    <div id="mobile-bar" >
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>

    <div id="header">
    <a id="logo" href="/">
        <img src="/images/logo.png">
        <span>Stellar</span>
    </a>
    <ul id="nav">
        <li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input">
  </form>
</li>
<li><a href="/guide/" class="nav-link current">Guide</a></li>
<li class="nav-dropdown-container">
  <a class="nav-link">Community</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="https://github.com/stellarFw/stellar" class="nav-link" target="_blank">GitHub</a></li>
    <li><a href="https://gitter.im/StellarFw/StellarFw" class="nav-link" target="_blank">Chat</a></li>
    <li><a href="https://twitter.com/gil0mendes" class="nav-link" target="_blank">Twitter</a></li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">Ecosystem</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="https://github.com/StellarFw/Identify" class="nav-link" target="_blank">Identify</a></li>
  </ul>
</li>


    </ul>
</div>

    
      <div id="main" class="fix-sidebar">
        
          
  <div class="sidebar">
  <ul class="main-menu">
    <li>
  <form id="search-form">
    <input type="text" id="search-query-sidebar" class="search-query st-default-search-input">
  </form>
</li>
<li><a href="/guide/" class="nav-link current">Guide</a></li>
<li class="nav-dropdown-container">
  <a class="nav-link">Community</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="https://github.com/stellarFw/stellar" class="nav-link" target="_blank">GitHub</a></li>
    <li><a href="https://gitter.im/StellarFw/StellarFw" class="nav-link" target="_blank">Chat</a></li>
    <li><a href="https://twitter.com/gil0mendes" class="nav-link" target="_blank">Twitter</a></li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">Ecosystem</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="https://github.com/StellarFw/Identify" class="nav-link" target="_blank">Identify</a></li>
  </ul>
</li>


  </ul>
  <div class="list">
    <div class="main-sponsor"></div>
    <a class="become-backer" href="/support-stellar">
      Become a Backer
    </a>

    <ul class="menu-root">
      
        <li>
          <a href="/guide/index.html" class="sidebar-link">Overview</a>
        </li>
      
        <li>
          <a href="/guide/installation.html" class="sidebar-link">Installation</a>
        </li>
      
        <li>
          <a href="/guide/actions.html" class="sidebar-link">Actions</a>
        </li>
      
        <li>
          <a href="/guide/models.html" class="sidebar-link">Models</a>
        </li>
      
        <li>
          <a href="/guide/tasks.html" class="sidebar-link current">Tasks</a>
        </li>
      
        <li>
          <a href="/guide/middleware.html" class="sidebar-link">Middleware</a>
        </li>
      
        <li>
          <a href="/guide/satellites.html" class="sidebar-link">Satellites</a>
        </li>
      
        <li>
          <a href="/guide/cluster.html" class="sidebar-link">Cluster</a>
        </li>
      
        <li>
          <a href="/guide/cache.html" class="sidebar-link">Cache</a>
        </li>
      
        <li>
          <a href="/guide/chat.html" class="sidebar-link">Chat</a>
        </li>
      
        <li>
          <a href="/guide/development_mode.html" class="sidebar-link">Development Mode</a>
        </li>
      
        <li>
          <a href="/guide/file_system.html" class="sidebar-link">File System</a>
        </li>
      
        <li>
          <a href="/guide/events.html" class="sidebar-link">Events</a>
        </li>
      
        <li>
          <a href="/guide/websocket.html" class="sidebar-link">WebSocket</a>
        </li>
      
        <li>
          <a href="/guide/tcp.html" class="sidebar-link">TCP</a>
        </li>
      
        <li>
          <a href="/guide/http.html" class="sidebar-link">HTTP</a>
        </li>
      
        <li>
          <a href="/guide/security.html" class="sidebar-link">Security</a>
        </li>
      
        <li>
          <a href="/guide/validation.html" class="sidebar-link">Validation</a>
        </li>
      
        <li>
          <a href="/guide/logging.html" class="sidebar-link">Logging</a>
        </li>
      
        <li>
          <a href="/guide/commands.html" class="sidebar-link">Commands</a>
        </li>
      
    </ul>
  </div>
</div>



<div class="content guide with-sidebar tasks-guide">
  
    <h1>Tasks</h1>
  

  <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>Tasks are jobs performed separately from client requests. They can be initialized by an action or by the server itself. With Stellar, there is no need to separately execute a daemon to process the work. Stellar uses the <code>node-resque</code> package for storing and processing tasks. In Stellar there are three ways of processing tasks: <code>normal</code>, <code>delayed</code> and <code>periodic</code>. In <code>normal</code> processing, the tasks are queued one by one by the <code>TaskProcessor</code>. When the task is <code>delayed</code>, it is inserted in a special queue which will be processed at a certain time in the future; the delay is set in milliseconds from the time of insertion or through a timestamp. Finally, <code>periodic</code> tasks are similar to <code>delayed</code> tasks, but <code>periodic</code> tasks are executed repeatedly with a certain frequency.</p>
<blockquote>
<p>Note: It is recommended to use tasks for sending emails and other operations that can be performed asynchronously in order to shorten client responses.</p>
</blockquote>
<h2 id="Types-of-Tasks"><a href="#Types-of-Tasks" class="headerlink" title="Types of Tasks"></a>Types of Tasks</h2><p>This subsection demonstrates the types of tasks that exist and how they can be used.</p>
<p>First, we have the <code>normal</code> tasks. Tasks of this type are added to a queue and processed in order of arrival as soon as there are free workers.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// api.tasks.enqueue(taskName, args, queue, callback)</span></div><div class="line">api.tasks.enqueue(<span class="string">'sendResetPasswordEmail'</span>, &#123; <span class="attr">to</span>: <span class="string">'gil00mendes@gmail.com'</span> &#125;, <span class="string">'default'</span>, (error, toRun) =&gt; &#123;</div><div class="line">  <span class="comment">// task enqueued!</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Then we have the <code>delayed</code> tasks. These tasks are enqueued in a special ‘delayed’ queue to be processed at some time in the future (defined either by a timestamp or a number of milliseconds from the time the task is created):</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// api.tasks.enqueueAt(timestamp, taskName, args, queue, callback)</span></div><div class="line">api.tasks.enqueueAt(<span class="number">1591629508</span>, <span class="string">'sendNotificationEmail'</span>, &#123; <span class="attr">to</span>: <span class="string">'gil00mendes@gmail.com'</span> &#125;, <span class="string">'default'</span>, (error, toRun) =&gt; &#123;</div><div class="line">  <span class="comment">// task enqueued!</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Finally, <code>periodic</code> tasks are like <code>delayed</code> tasks, but they run on a set frequency (e.g., every 5 minutes):</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// api.tasks.enqueueIn(delay, taskName, args, queue, callback)</span></div><div class="line">api.tasks.enqueueIn(<span class="number">60000</span>, <span class="string">'sendNotificationEmail'</span>, &#123; <span class="attr">to</span>: <span class="string">'gil00mendes@gmail.com'</span> &#125;, <span class="string">'default'</span>, (error, toRun) =&gt; &#123;</div><div class="line">  <span class="comment">// task enqueued!</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<blockquote>
<p>Note: Periodic tasks can take no input parameters.</p>
</blockquote>
<h2 id="Create-an-Task"><a href="#Create-an-Task" class="headerlink" title="Create an Task"></a>Create an Task</h2><p>The actions are stored in the <code>/tasks</code> folder inside each module. To generate a new task you can run the command: <code>stellar makeTask &lt;task_name&gt; --module=&lt;module_name&gt;</code>. A task has some mandatory properties, which are described in the next section.</p>
<h3 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h3><p>The list below are the properties supported by the tasks. The properties <code>name</code>, <code>description</code>, and <code>run</code> are mandatory.</p>
<ul>
<li><strong><code>name</code></strong>: Name of the task, which must be unique.</li>
<li><strong><code>description</code></strong>: Must contain a short description of the purpose of the task.</li>
<li><strong><code>queue</code></strong>: <code>Queue</code> which will run the task, by default this property is set to <code>default</code>. This value can be replaced when using the <code>api.tasks.enqueue</code> methods.</li>
<li><strong><code>frequency</code></strong>: If the value is greater than zero, the task will be considered a periodic task and will run once every interval specified by the number of milliseconds defined in this property.</li>
<li><strong><code>plugins</code></strong>: In this property you can define an array of resque plugins; these plugins modify how tasks are inserted in the queue. You can read more about this in the <a href="https://github.com/taskrabbit/node-resque" target="_blank" rel="external">node-resque</a> docs.</li>
<li><strong><code>pluginOptions</code></strong>: This is an object with options for plugins.</li>
<li><strong><code>run(api, params, next)</code></strong>: A function that implements the operations to be performed by the task.</li>
</ul>
<blockquote>
<p>Note: for the task name it is recommended to use a namespace; e.g., <code>auth.sessionValidation</code>.</p>
</blockquote>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>The example below shows the structure of a task which records a message “Hello!!!” every second:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">exports.sayHello = &#123;</div><div class="line">  <span class="attr">name</span>: <span class="string">'sayHello'</span>,</div><div class="line">  <span class="attr">description</span>: <span class="string">'I say hello'</span>,</div><div class="line">  <span class="attr">queue</span>: <span class="string">'default'</span>,</div><div class="line">  <span class="attr">frequency</span>: <span class="number">1000</span>,</div><div class="line"></div><div class="line">  <span class="attr">run</span>: <span class="function">(<span class="params">api, params, next</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">// log a new message</span></div><div class="line">    api.log(<span class="string">'Hello!!!'</span>)</div><div class="line"></div><div class="line">    <span class="comment">// finish the task execution</span></div><div class="line">    next()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Task-Management"><a href="#Task-Management" class="headerlink" title="Task Management"></a>Task Management</h2><p>Stellar has a number methods which allow you to manage and query the state of the task queues.</p>
<h3 id="Remove-a-Task"><a href="#Remove-a-Task" class="headerlink" title="Remove a Task"></a>Remove a Task</h3><p>Remove all tasks which match the given parameters - <code>api.tasks.del(queue, taskName, args, count, callback)</code>:</p>
<ul>
<li><strong><code>queue</code></strong>: Name of the queue from which the task(s) must be removed.</li>
<li><strong><code>taskName</code></strong>: Task name to be removed.</li>
<li><strong><code>args</code></strong>: Search arguments (for more information on this you can read the <code>node-resque</code> documentation).</li>
<li><strong><code>count</code></strong>: Number of task instances which must be removed.</li>
</ul>
<h3 id="Remove-a-Task-with-Delay"><a href="#Remove-a-Task-with-Delay" class="headerlink" title="Remove a Task with Delay"></a>Remove a Task with Delay</h3><p>Remove all tasks with delay which match the given parameters - <code>api.tasks.delDelayed(queue, taskName, args, callback)</code>:</p>
<ul>
<li><strong><code>queue</code></strong>: Name of the queue from which the task(s) must be removed.</li>
<li><strong><code>taskName</code></strong>: Task name to be removed.</li>
<li><strong><code>args</code></strong>: Search arguments (more information about this can be found in the <code>node-resque</code> documentation).</li>
</ul>
<h3 id="Clean-a-Queue"><a href="#Clean-a-Queue" class="headerlink" title="Clean a Queue"></a>Clean a Queue</h3><p>The <code>api.tasks.delQueue(queue, callback)</code> method removes all the tasks in a queue:</p>
<ul>
<li><strong><code>queue</code></strong>: Queue name where the tasks must be all removed.</li>
</ul>
<h3 id="Recurrent-Jobs"><a href="#Recurrent-Jobs" class="headerlink" title="Recurrent Jobs"></a>Recurrent Jobs</h3><p>The <code>api.tasks.enqueueRecurrentJob(taskName, callback)</code> method allows you add a new recurrent job:</p>
<ul>
<li><strong><code>taskName</code></strong>: Task name to be added.</li>
</ul>
<h3 id="Stop-Recurrent-Jobs"><a href="#Stop-Recurrent-Jobs" class="headerlink" title="Stop Recurrent Jobs"></a>Stop Recurrent Jobs</h3><p>The <code>api.tasks.stopRecurrentJob(taskName, callback)</code> method allows you stop a recurrent job:</p>
<ul>
<li><strong><code>taskName</code></strong>: Task name to be removed from the recurrent queue.</li>
</ul>
<h3 id="Tasks-with-Timestamps"><a href="#Tasks-with-Timestamps" class="headerlink" title="Tasks with Timestamps"></a>Tasks with Timestamps</h3><p>The <code>api.tasks.timestamps(callback)</code> method allows you get an array with all tasks with an associated timestamp.</p>
<h3 id="Statistics"><a href="#Statistics" class="headerlink" title="Statistics"></a>Statistics</h3><p>The <code>api.tasks.stats(callback)</code> method allows you to get an array with all statistics of the resque cluster.</p>
<h3 id="Locks"><a href="#Locks" class="headerlink" title="Locks"></a>Locks</h3><p>The <code>api.tasks.locks(callback)</code> method allows you to get an array with all existing locks in the cluster.</p>
<h3 id="Remove-a-Lock"><a href="#Remove-a-Lock" class="headerlink" title="Remove a Lock"></a>Remove a Lock</h3><p>The <code>api.tasks.delLock(lockName, callback)</code> method allows you to remove a lock from the cluster:</p>
<ul>
<li><strong><code>lockName</code></strong>: Lock name to be removed.</li>
<li><strong><code>callback(removed, error)</code></strong>: Callback function.<ul>
<li><strong><code>removed</code></strong>: Set to <code>1</code> if the lock as been removed.</li>
<li><strong><code>error</code></strong>: <code>Error</code> instance if an error occurs during the request.</li>
</ul>
</li>
</ul>
<h3 id="Remove-Tasks-on-a-Timestamp"><a href="#Remove-Tasks-on-a-Timestamp" class="headerlink" title="Remove Tasks on a Timestamp"></a>Remove Tasks on a Timestamp</h3><p>The <code>api.tasks.delDelayesAt(timestamp, callback)</code> method removes all tasks on the requested timestamp:</p>
<ul>
<li><strong><code>timestamp</code></strong>: Timestamp for the tasks that must be removed.</li>
</ul>
<h3 id="Remove-all-Tasks-with-Delay"><a href="#Remove-all-Tasks-with-Delay" class="headerlink" title="Remove all Tasks with Delay"></a>Remove all Tasks with Delay</h3><p>The <code>api.tasks.allDelayed(callback)</code> method allows you to remove all tasks with delay.</p>
<h3 id="Get-Workers"><a href="#Get-Workers" class="headerlink" title="Get Workers"></a>Get Workers</h3><p>The <code>api.tasks.workers(callback)</code> method allows you to get all <code>TaskProcessors</code> instances.</p>
<h3 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h3><p>The <code>api.tasks.details(callback)</code> method allows you to get information about the existing queues.</p>
<h3 id="Failed-Count"><a href="#Failed-Count" class="headerlink" title="Failed Count"></a>Failed Count</h3><p>The <code>api.tasks.failedCount(callback)</code> method allows you to get the number of failed jobs.</p>
<h3 id="Remove-a-Failed-Job"><a href="#Remove-a-Failed-Job" class="headerlink" title="Remove a Failed Job"></a>Remove a Failed Job</h3><p>The <code>api.tasks.removeFailed(failedJob, callback)</code> method allows you remove a task from the failed jobs queue.</p>
<h3 id="Retry-a-Failed-Job"><a href="#Retry-a-Failed-Job" class="headerlink" title="Retry a Failed Job"></a>Retry a Failed Job</h3><p>The <code>api.tasks.retryAndRemoveFailed(failedJob, callback)</code> method allows you to retry failed task and remove that task from the failed jobs queue.</p>
<ul>
<li><strong><code>failedJob</code></strong>: Task name.</li>
</ul>
<h2 id="Failed-Job-Management"><a href="#Failed-Job-Management" class="headerlink" title="Failed Job Management"></a>Failed Job Management</h2><p>Periodic tasks cannot receive input parameters. Sometimes a worker crashes is a severe way, and it doesn’t have a chance to notify Redis that it is leaving the pool (this happens often on PaaS like Heroku). When this happens, you will not only need to extract the job from the now-dead worker’s “working on” status, but also remove the stuck worker. To aid you in these edge cases, <code>api.tasks.cleanOldWorkers(age, callback)</code> is available.</p>
<p>Because there are no ‘heartbeats’ in resque, it is impossible for the application to know whether a worker has been working on a long job or it is dead.</p>


  
      <div class="guide-links">
        
          <span>← <a href="/guide/models.html">Models</a></span>
        
        
          <span style="float:right"><a href="/guide/middleware.html">Middleware</a> →</span>
        
      </div>
    

    <div class="footer">
      Caught a mistake or want to contribute to documentation?
      <a href="https://github.com/StellarFw/stellar-framework.com/tree/master/src/guide/tasks.md" target="_blank">
        Edit this page on Github!
      </a>
    </div>
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- search -->
    <link href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/search.css">
    <script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js" type="text/javascript"></script>

    <!-- main custom script for sidebar and other cool things -->
    <script src="/js/common.js"></script>

    <!-- ga -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-77611901-1', 'stellar-framework.com');
      ga('send', 'pageview');
    </script>

    <!-- fastclick  -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        FastClick.attach(document.body)
      }, false)
    </script>
  </body>
</html>
